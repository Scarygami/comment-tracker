<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-icon/core-icon.html">
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<link rel="import" href="../bower_components/core-icons/iconsets/social-icons.html">
<link rel="import" href="../bower_components/core-icons/iconsets/communication-icons.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-localstorage/core-localstorage.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-tooltip/core-tooltip.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="comment-tracker-source.html">
<link rel="import" href="comment-tracker-entry.html">
<link rel="import" href="comment-tracker-share.html">
<link rel="import" href="twitter-fetcher.html">
<link rel="import" href="text-screen.html">

<polymer-element name="comment-tracker" attributes="apikey ytapikey">
  <template>

    <style>

      * { box-sizing: border-box; margin: 0;}

      /* prevent bleeding on firefox */
      paper-toggle-button /deep/ * { box-sizing: content-box; }

      :host {
        display: block;
        width: 100%;
        height: 100%;
        margin: 0; padding: 0;
        position: relative;
        font-family: 'Roboto Condensed', 'Helvetica', 'Arial', sans-serif;
        font-weight: 300;
        background-color: #FFFFFF;
        box-sizing: border-box;
        min-height: 100%;
      }

      core-header-panel {
        width: 100%;
        height: 100%;
      }

      core-header-panel::shadow #mainContainer {
        overflow-y: scroll;
      }

      .core-header {
        background-color: #181;
        color: #FEFEFE;
        font-weight: 300;
      }

      core-toolbar {
        background-color: #181;
        font-size: 1.5em;
      }

      core-toolbar paper-icon-button {
        fill: white;
      }

      core-toolbar, section {
        margin: 0 auto;
      }

      .tabs {
        visibility: hidden;
      }

      .navdrawer-container {
        z-index: 1;
        position: fixed;
        top: 0;
        bottom: 0;
        width: 150px;
        height: 100%;
        background-color: #181;
        color: #FEFEFE;
        -webkit-transform: translate(-155px, 0);
        transform: translate(-155px, 0);
        overflow-y: auto;
        margin: 0;
        transition: -webkit-transform 0.3s ease-out;
        transition: transform 0.3s ease-out;
        box-shadow: 4px 4px 4px rgba(0, 0, 0, 0.4);
      }

      .navdrawer-container.open {
        -webkit-transform: translate(0, 0);
        transform: translate(0, 0);
      }

      .navdrawer-container h4,
      .navdrawer-container paper-item {
        height: 64px;
        padding: 0 20px;
        line-height: 64px;
      }

      .navdrawer-container h4 {
        background-color: white;
        color: #181;
        cursor: pointer;
      }

      .navdrawer-container core-menu {
        padding: 0;
        margin: 0;
      }

      .navdrawer-container paper-item {
        border-bottom-style: solid;
        border-width: 1px;
        border-color: white;
      }

      .navdrawer-container paper-item:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }

      .navdrawer-container paper-item.core-selected {
        background-color: rgba(255, 255, 255, 0.4);
      }

      section {
        padding: 8px;
      }

      .appname {
        display: none;
      }

      .settings {
        width: 200px;
        margin: 16px auto;
      }

      .settings .setting {
        width: 200px;
      }

      .setting paper-toggle-button::shadow paper-radio-button::shadow #ink[checked] {
        color: #181;
      }

      .setting > span {
        margin-right: 4px;
      }

      .about {
        max-width: 280px;
        margin: 16px auto;
      }

      .about > div {
        margin-bottom: 6px;
      }

      .about core-icon {
        margin-right: 6px;
      }

      paper-tab {
        cursor: pointer;
      }

      core-pages > section {
        display: none;
      }

      core-pages > section.core-selected {
        display: block;
      }

      #spinner {
        margin: 12px 0;
      }

      @media all and (min-device-width: 1200px) and (min-width: 450px) {
        .appname {
          display: inline-block;
        }
        .menuname {
          display: none;
        }
        .menu {
          display: none;
        }

        .tabs {
          visibility: visible;
        }

        core-toolbar, section {
          max-width: 864px;
        }

        core-toolbar {
          height: 100px;
        }

        .navdrawer-container.open {
          -webkit-transform: translate(-155px, 0);
          transform: translate(-155px, 0);
        }

        a {
          text-decoration: none;
        }

        a:hover, a:active {
          text-decoration: underline;
        }

        section {
          padding: 16px;
        }
      }

    </style>

    <nav id="navdrawer" class="navdrawer-container promote-layer" on-click="{{closeMenu}}">
      <h4>Navigation</h4>
      <core-menu selected="{{menuItem}}">
        <paper-item label="Sources"></paper-item>
        <paper-item label="Stream"></paper-item>
        <template if="{{hangout}}">
          <paper-item label="Shares"></paper-item>
        </template>
        <paper-item label="Settings"></paper-item>
        <paper-item label="About"></paper-item>
      </core-menu>
    </nav>

    <core-header-panel>
      <div class="core-header">
        <core-toolbar>
          <paper-icon-button class="menu" icon="menu" on-click="{{toggleMenu}}"></paper-icon-button>
          <div flex class="title">
            <span class="appname">Comment Tracker</span>
            <span class="menuname">
              {{menuItem == 0 ? 'CT Sources' : ''}}
              {{menuItem == 1 ? 'CT Stream' : ''}}
              {{(hangout && menuItem == 2) ? 'CT Shares': ''}}
              {{menuItem == (hangout ? 3 : 2) ? 'CT Settings' : ''}}
              {{menuItem == (hangout ? 4 : 3) ? 'CT About' : ''}}
            </span>
          </div>
          <template if="{{!hangout}}">
            <paper-icon-button icon="communication:hangout" on-click="{{openHangout}}"></paper-icon-button>
          </template>
          <paper-icon-button icon="launch" on-click="{{openTracker}}"></paper-icon-button>
          <div class="bottom fit tabs" horizontal center-justified end layout>
            <paper-tabs selected="{{menuItem}}" flex noink>
              <paper-tab>Sources</paper-tab>
              <paper-tab>Stream</paper-tab>
              <template if="{{hangout}}">
                <paper-tab>Shares</paper-tab>
              </template>
              <paper-tab>Settings</paper-tab>
              <paper-tab>About</paper-tab>
            </paper-tabs>
          </div>
        </core-toolbar>
      </div>
      <core-pages selected="{{menuItem}}">
        <section on-click="{{closeMenu}}">
          <div layout horizontal>
            <paper-input flex
              label="Source URL / Search Term"
              on-keydown="{{addKey}}"
              inputValue="{{sourceValue}}"
              disabled?="{{parsing > 0}}"></paper-input>
            <paper-icon-button
              icon="add"
              on-tap="{{add}}"
              on-keydown="{{addKey}}"
              role="button"
              aria-label="Add source"
              disabled?="{{parsing > 0}}"></paper-icon-button>
            <template if="{{ parsing > 0 }}">
              <core-icon id="spinner" src="images/spinner.gif" size="16"></core-icon>
            </template>
          </div>
          <template repeat="{{source in sources}}">
            <comment-tracker-source
              type="{{source.type}}"
              sourceid="{{source.id}}"
              user="{{source.user}}"
              col="{{source.col}}"
              data="{{source.data}}"
              colours="{{colours}}"
              apikey="{{apikey}}"
              ytapikey="{{ytapikey}}"
              fullPost="{{fullSources}}"
              hiddenActions="{{!visibleActions}}"
              on-comment-tracker-update="{{refresh}}"
              on-comment-tracker-delete-source="{{deleteSource}}"
              on-comment-tracker-add-source="{{addSource}}"
            ></comment-tracker-source>
          </template><br><br><br>
        </section>
        <section on-click="{{closeMenu}}">
          <template if="{{entries.length > 0}}">
            <div class="setting" layout horizontal center end-justified>
              <span>Show hidden</span>
              <paper-toggle-button checked="{{hiddenEntries}}"></paper-toggle-button>
            </div>
          </template>
          <template repeat="{{entry in entries}}">
            <comment-tracker-entry
              type="{{entry.type}}"
              entryid="{{entry.id}}"
              col="{{entry.col}}"
              colours="{{colours}}"
              data="{{entry.data}}"
              pinned="{{entry.pinned}}"
              shorten="{{!fullComments}}"
              showing="{{entry.showing}}"
              hiddenActions="{{!visibleActions}}"
              hiddenEntries="{{hiddenEntries}}"
              on-comment-tracker-update="{{refresh}}"
              on-comment-tracker-add-source="{{addSource}}"
              on-comment-tracker-show-screen="{{showScreen}}"
              on-comment-tracker-hide-screen="{{hideScreen}}"
            ></comment-tracker-entry>
          </template><br><br><br>
          <template if="{{hangout}}">
            <text-screen id="textScreen"></text-screen>
          </template>
        </section>
        <template if="{{hangout}}">
        <section on-click="{{closeMenu}}">
          <template if="{{sources.length > 0}}">
            <div layout horizontal center end-justified>
              <span>Tracking {{sources.length}} source{{sources.length !== 1 ? 's' : ''}}</span>
              <paper-icon-button
                icon="social:share"
                on-tap="{{shareSources}}"
                on-keydown="{{shareSourcesKey}}"
                role="button"
                aria-label="Share sources"></paper-icon-button>
            </div>
          </template>
          <template if="{{shares.length > 0}}">
            <div class="setting" layout horizontal center end-justified>
              <span>Show hidden</span>
              <paper-toggle-button checked="{{hiddenShares}}"></paper-toggle-button>
            </div>
          </template>

          <template repeat="{{share in shares}}">
            <comment-tracker-share
              type="{{share.type}}"
              sourceid="{{share.id}}"
              user="{{share.user}}"
              data="{{share.data}}"
              added="{{share.added}}"
              fullPost="{{!shortenSources}}"
              hiddenActions="{{hiddenActions}}"
              hiddenShares="{{hiddenShares}}"
              on-comment-tracker-add-source="{{addSource}}"
            ></comment-tracker-share>
          </template><br><br><br>
        </section>
        </template>
        <section on-click="{{closeMenu}}">
          <div class="settings">
            <core-localstorage name="colours" value="{{colours}}"></core-localstorage>
            <core-tooltip noarrow>
              <div class="setting" layout horizontal>
                <span flex>Colours</span>
                <paper-toggle-button checked="{{colours}}"></paper-toggle-button>
              </div>
              <div tip>
                On - Coloured bar on top of cards<br><br>
                Off - No coloured bars
              </div>
            </core-tooltip><br><br>
            <core-localstorage name="newestFirst" value="{{newestFirst}}"></core-localstorage>
            <core-tooltip noarrow>
              <div class="setting" layout horizontal>
                <span flex>Newest first</span>
                <paper-toggle-button checked="{{newestFirst}}"></paper-toggle-button>
              </div>
              <div tip>
                On - New comments at the top of the stream<br><br>
                Off - New comments at the bottom
              </div>
            </core-tooltip><br><br>
            <core-localstorage name="visibleActions" value="{{visibleActions}}"></core-localstorage>
            <core-tooltip noarrow>
              <div class="setting" layout horizontal>
                <span flex>Visible Actions</span>
                <paper-toggle-button checked="{{visibleActions}}"></paper-toggle-button>
              </div>
              <div tip>
                On - Actions are always displayed<br><br>
                Off - Actions appear if you hover over cards
              </div>
            </core-tooltip><br><br>
            <core-localstorage name="fullComments" value="{{fullComments}}"></core-localstorage>
            <core-tooltip noarrow>
              <div class="setting" layout horizontal>
                <span flex>Full Comments</span>
                <paper-toggle-button checked="{{fullComments}}"></paper-toggle-button>
              </div>
              <div tip>
                On - Full comments are displayed<br><br>
                Off - Comments are cut off
              </div>
            </core-tooltip><br><br>
            <core-localstorage name="fullSources" value="{{fullSources}}"></core-localstorage>
            <core-tooltip noarrow>
              <div class="setting" layout horizontal>
                <span flex>Full Sources</span>
                <paper-toggle-button checked="{{fullSources}}"></paper-toggle-button>
              </div>
              <div tip>
                On - Full posts/video descriptions are displayed<br><br>
                Off - Only titles of posts/videos are displayed
              </div>
            </core-tooltip><br><br>
          </div>
        </section>
        <section on-click="{{closeMenu}}">
          <div class="about">
            <img src="https://www.foldedsoft.at/plus/comment-tracker/images/comment-tracker.png" alt="Comment Tracker" style="vertical-align: middle;"> <b>Comment Tracker</b><br><br>
            <div layout horizontal center>
              <core-icon icon="info-outline"></core-icon>
              <span flex>
                <a href="http://www.allmyplus.com/comment-tracker/" target="_blank">Website</a> /
                <a href="http://www.allmyplus.com/comment-tracker/tos.html" target="_blank">TOS</a> /
                <a href="http://www.allmyplus.com/comment-tracker/privacy.html" target="_blank">Privacy Policy</a>
              </span>
            </div>
            <div layout horizontal center>
              <core-icon icon="social:person"></core-icon>
              <span flex>
                <a href="https://plus.google.com/112336147904981294875" target="_blank">Gerwin Sturm</a> /
                <a href="http://www.foldedsoft.at/" target="_blank">FoldedSoft e.U.</a>
              </span>
            </div>
            <div layout horizontal center>
              <core-icon icon="social:person"></core-icon>
              <span flex>
                <a href="https://plus.google.com/101852559274654726533" target="_blank">Allen "Prisoner" Firstenberg</a>
                (TextScreen)
              </span>
            </div>
            <div layout horizontal center>
              <core-icon icon="social:person"></core-icon>
              <span flex>
                <a href="https://plus.google.com/110804953626559077511/posts" target="_blank">Jason Mayes</a>
                (Twitter Fetcher)
              </span>
            </div>

            <div layout horizontal center>
              <core-icon icon="bug-report"></core-icon>
              <span flex><a href="https://github.com/Scarygami/comment_tracker" target="_blank">GitHub</a></span>
            </div><br><br><br>

            <form action="https://www.paypal.com/cgi-bin/webscr" method="post" style="display: inline-block;" target="_blank">
              <input type="hidden" name="cmd" value="_s-xclick">
              <input type="hidden" name="hosted_button_id" value="B3Y4M6Y5HYFBE">
              <input type="image" src="images/fund.png" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" title="Enable me to spend more time on projects like this :)" class="fund">
              <img alt="" border="0" src="https://www.paypalobjects.com/de_DE/i/scr/pixel.gif" width="1" height="1">
            </form>
            <a href="http://www.amazon.de/registry/wishlist/34WAK3OTR8PRN" target="_blank"><img src="images/amazon.png" alt="Amazon Wishlist" title="Some stuff that would make me happy :)" class="fund"></a>
          </div>
        </section>
      </core-pages>
    </core-header-panel>
    <paper-toast id="warning" text="{{warning}}"></paper-toast>
  </template>

  <script>
    (function (global) {
      var
        thisHandler,
        colors = ['#FF0', '#0F0', '#00F', '#F0F', '#F00', '#0FF', '#F90', '#0F9'];

      function addSource(type, user, id, reshare, shared, cb) {
        var ajax, i, found, tmp, sources;

        thisHandler.parsing++;

        sources = shared ? thisHandler.shares : thisHandler.sources;

        found = false;

        for (i = 0; i < sources.length; i++) {
          tmp = sources[i];
          if (tmp.type == type) {
            if (tmp.user == user && tmp.id == id) {
              found = true;
              break;
            }
            if (type == 'post' && tmp.activityId == id) {
              found = true;
              break;
            }
          }
        }

        if (found) {
          global.setTimeout(function () {
            cb(null, 'Source already added');
          }, 0);
          return;
        }

        switch (type) {
          case 'twitter':
            ajax = global.document.createElement('twitter-fetcher');
            ajax.widget = id;
            ajax.max = 1;
            ajax.retweets = false;
            ajax.links = true;
            ajax.addEventListener('twitter-fetcher-response', function () {
              if (ajax.response && ajax.response.widget) {
                cb({
                  type: 'twitter',
                  user: null,
                  id: id,
                  data: ajax.response.widget
                });
              } else {
                cb(null);
              }
            });
            ajax.go();
            return;
          case 'post':
            if (user) {
              ajax = global.document.createElement('core-ajax');

              ajax.url = 'https://www.googleapis.com/plus/v1/people/' + user +
                         '/activities/public?maxResults=100&key=' + thisHandler.apikey;

              ajax.handleAs = 'json';
              ajax.addEventListener('core-complete', function() {
                var i, post, tmp;
                if (ajax.response && ajax.response.items && ajax.response.items.length > 0) {
                  for (i = 0; i < ajax.response.items.length; i++) {
                    if (reshare && ajax.response.items[i].object.id === reshare) {
                      post = ajax.response.items[i];
                      break;
                    }
                    tmp = ajax.response.items[i].url.split('/');
                    if (tmp.length > 0) {
                      if (tmp[tmp.length - 1] === id) {
                        post = ajax.response.items[i];
                        break;
                      }
                    }
                  }
                  if (post) {
                    for (i = 0; i < sources.length; i++) {
                      tmp = sources[i];
                      if (tmp.type == 'post' && (tmp.activityId == post.id)) {
                        cb(null, 'Source already added');
                        return;
                      }
                    }
                    cb({
                      type: 'post',
                      user: user,
                      id: id,
                      activityId: post.id,
                      data: post
                    });
                  } else {
                    cb(null);
                  }
                } else {
                  cb(null);
                }
              });
              ajax.go();
            } else {
              ajax = global.document.createElement('core-ajax');
              ajax.url = 'https://www.googleapis.com/plus/v1/activities/' + id + '?key=' + thisHandler.apikey;
              ajax.handleAs = 'json';
              ajax.addEventListener('core-complete', function() {
                if (ajax.response && ajax.response.id) {
                  cb({
                    type: 'post',
                    user: user,
                    id: id,
                    activityId: ajax.response.id,
                    data: ajax.response
                  });
                } else {
                  cb(null);
                }
              });
              ajax.go();
            }
            return;
          case 'person':
            ajax = global.document.createElement('core-ajax');
            ajax.url = 'https://www.googleapis.com/plus/v1/people/' + user + '?key=' + thisHandler.apikey;
            ajax.handleAs = 'json';
            ajax.addEventListener('core-complete', function() {
              if (ajax.response && ajax.response.id) {
                cb({
                  type: 'person',
                  user: user,
                  id: null,
                  data: ajax.response
                });
              } else {
                cb(null);
              }
            });
            ajax.go();
            return;
          case 'gsearch':
            global.setTimeout(function () {
              cb({
                type: 'gsearch',
                user: null,
                id: id
              });
            }, 0);
            return;
          case 'yt':
            ajax = global.document.createElement('core-ajax');
            ajax.url = 'https://gdata.youtube.com/feeds/api/videos/' + id + '?alt=json&key=' + thisHandler.ytapikey;
            ajax.handleAs = 'json';
            ajax.addEventListener('core-complete', function() {
              var video, tmp, ajax2;
              if (ajax.response && ajax.response.entry) {
                video = ajax.response.entry;
                video.author[0].img = thisHandler.resolvePath('images/youtube_big.png');
                ajax2 = global.document.createElement('core-ajax');
                ajax2.url = video.author[0].uri.$t + '?alt=json&key=' + thisHandler.ytapikey;
                ajax2.handleAs = 'json';
                ajax2.addEventListener('core-complete', function() {
                  if (ajax2.response && ajax2.response.entry) {
                    if (ajax2.response.entry.media$thumbnail && ajax2.response.entry.media$thumbnail.url) {
                      video.author[0].img = ajax2.response.entry.media$thumbnail.url;
                    }
                  }
                  cb({
                    type: 'yt',
                    user: null,
                    id: id,
                    data: video
                  });
                });
                ajax2.go();
              } else {
                cb(null);
              }
            });
            ajax.go();
            return;
        }

        global.setTimeout(function () {
          cb(null);
        }, 0);
      }

      function parseSource(source, cb) {
        var parts, l, source_type, source_user, source_id, i, param;

        function innerCallback(data, warning) {
          thisHandler.parsing--;
          global.setTimeout(function () {
            cb(data, warning || "Couldn't find source");
          }, 1);
        }

        if (!source) { cb(null, null, true); return; }

        if (source.search(/allmyplus\.com/gi) >= 0 ||
            source.search(/scary-experiments\.appspot\.com/gi) >= 0 ||
            source.search(/localhost:8080/gi) >= 0) {

          i = source.toLowerCase().indexOf('?');
          if (i > 0) {
            source = source.substr(i + 1);
            parts = source.split('&');
            for (i = 0; i < parts.length; i++) {
              if (parts[i]) {
                param = parts[i].split('=');
                if (param.length === 2) {
                  param[1] = decodeURIComponent(param[1].replace(/\+/g, ' '));
                  switch (param[0].toLowerCase()) {
                    case 'post':
                      addSource('post', null, param[1], null, false, innerCallback);
                      break;
                    case 'twitter':
                      addSource('twitter', null, param[1], null, false, innerCallback);
                      break;
                    case 'gsearch':
                      addSource('gsearch', null, param[1], null, false, innerCallback);
                      break;
                    case 'yt':
                      addSource('yt', null, param[1], null, false, innerCallback);
                      break;
                    case 'person':
                      addSource('person', param[1], null, null, false, innerCallback);
                      break;
                    case 'gd':
                      parseSource('http://www.allmyplus.com/comment-tracker/app.html?' + param[1], cb);
                      break;
                  }
                }
              }
            }
          } else {
            cb(null, 'Invalid Comment Tracker source');
          }
          return;
        }

        if (source.search(/twitter\.com/gi) >= 0) {
          source = source.split('?')[0];
          parts = source.split('/');
          i = parts.indexOf('widgets') + 1;
          if (i > 0 && i < parts.length) {
            source_type = 'twitter';
            source_user = null;
            source_id = parts[i];
            addSource(source_type, source_user, source_id, null, false, innerCallback);
            return;
          }

          cb(null, 'Invalid Twitter source');
          return;
        }

        if (!source_type && source.search(/plus\.google\.com/gi) >= 0) {
          source = source.split('?')[0];
          parts = source.split('/');
          l = parts.length;
          if (parts[l - 2] === 'posts' && l >= 3) {
            source_type = 'post';
            source_user = parts[l - 3];
            source_id = parts[l - 1];
            addSource(source_type, source_user, source_id, null, false, innerCallback);
            return;
          }

          for (i = parts.length - 1; i >= 0; i--) {
            if (!!parts[i].match(/[0-9]{10,}/) || !!parts[i].match(/\+(\w)+/)) {
              source_type = 'person';
              source_user = parts[i];
              source_id = null;
              addSource(source_type, source_user, source_id, null, false, innerCallback);
              return;
            }
          }

          cb(null, 'Invalid Google+ Source');
          return;
        }

        if (!source_type && (source.search(/youtube\.com/gi) >= 0 || source.search(/youtu\.be/gi) >= 0)) {
          source_id = '';
          i = source.search(/\?v=/gi);
          if (i >= 0) {
            source_id = source.substr(i + 3);
          }
          if (!source_id) {
            i = source.search(/youtu\.be\//gi);
            if (i >= 0) {
              source_id = source.substr(i + 9);
            }
          }
          if (!source_id) {
            i = source.search(/\/embed\//gi);
            if (i >= 0) {
              source_id = source.substr(i + 7);
            }
          }

          if (source_id !== '') {
            i = source_id.search(/[\&\#\/\"\']/);
            if (i >= 0) {
              source_id = source_id.substring(0, i);
            }
          }

          if (source_id !== '') {
            source_type = 'yt';
            source_user = null;
            addSource(source_type, source_user, source_id, null, false, innerCallback);
            return;
          }

          cb(null, 'Invalid YouTube source');
          return;
        }

        addSource('gsearch', null, source, null, false, innerCallback);
      }

      Polymer('comment-tracker', {
        menuItem: 0,
        parsing: 0,
        sources: [],
        entries: [],
        shares: [],
        hangout: false,
        colours: true,
        newestFirst: true,
        visibleActions: true,
        fullComments: true,
        fullSources: false,
        hiddenShares: false,
        hiddenEntries: false,
        addSource: function (e, details) {
          var i;
          if (details.type == 'yt-comments') {
            for (i = 0; i < this.entries.length; i++) {
              if (this.entries[i].type == 'yt' && this.entries[i].sourceid == details.id && !!this.entries[i].data.postId) {
                this.addSource(null, {
                  type: 'post',
                  user: null,
                  id: this.entries[i].data.postId,
                  shared: details.shared
                });
              }
            }
            return;
          }
          addSource(details.type, details.user, details.id, details.reshare, details.shared, function (source) {
            thisHandler.parsing--;
            if (source) {
              if (details.shared) {
                this.shares.push(source);
              } else {
                source.col = colors[this.sources.length % colors.length];
                this.sources.push(source);
              }
            }
            this.showHideShares();
          }.bind(this));
        },
        deleteSource: function (e, details) {
          var i = 0;
          while (i < this.entries.length) {
            if (this.entries[i].type == details.type && this.entries[i].sourceid == details.id && this.entries[i].sourceuser == details.user) {
              this.entries.splice(i, 1);
            } else {
              i += 1;
            }
          }
          for (i = 0; i < this.sources.length; i++) {
            if (this.sources[i].type == details.type && this.sources[i].id == details.id && this.sources[i].user == details.user) {
              this.sources.splice(i, 1);
              break;
            }
          }
          this.showHideShares();
        },
        showScreen: function (e, details) {
          var ts = this.shadowRoot.getElementById('textScreen'), i;
          if (!ts) {
            global.console.log('textScreen not found');
            return;
          }
          ts.text = details.text;
          ts.img = details.img;
          ts.show();
          for (i = 0; i < this.entries.length; i++) {
            if (this.entries[i].showing && (this.entries[i].type != details.type || this.entries[i].id != details.id)) {
              this.entries[i].showing = false;
            }
          }
        },
        hideScreen: function () {
          var ts = this.shadowRoot.getElementById('textScreen');
          if (!ts) {
            global.console.log('textScreen not found');
            return;
          }
          ts.hide();
        },
        toggleMenu: function () {
          this.$.navdrawer.classList.toggle('open');
        },
        closeMenu: function () {
          this.$.navdrawer.classList.remove('open');
        },
        openTracker: function () {
          var base = global.location.href, i, params;
          base = base.substring(0, base.lastIndexOf('/') + 1) + 'app.html';
          params = [];
          for (i = 0; i < this.sources.length; i++) {
            switch (this.sources[i].type) {
              case 'post':
                params.push('post=' + encodeURIComponent(this.sources[i].activityId));
                break;
              case 'person':
                params.push('person=' + encodeURIComponent(this.sources[i].user));
                break;
              case 'yt': case 'twitter': case 'gsearch':
                params.push(this.sources[i].type + '=' + encodeURIComponent(this.sources[i].id));
                break;
            }
          }
          global.open(base + '?' + params.join('&'));
        },
        openHangout: function () {
          var base, i, params;
          base = 'https://plus.google.com/hangouts/_?gid=947523017864&gd=';
          params = [];
          for (i = 0; i < this.sources.length; i++) {
            switch (this.sources[i].type) {
              case 'post':
                params.push('post=' + encodeURIComponent(this.sources[i].activityId));
                break;
              case 'person':
                params.push('person=' + encodeURIComponent(this.sources[i].user));
                break;
              case 'yt': case 'twitter': case 'gsearch':
                params.push(this.sources[i].type + '=' + encodeURIComponent(this.sources[i].id));
                break;
            }
          }
          global.open(base + encodeURIComponent(params.join('&')));
        },
        addKey: function (e) {
          if (e.which == 13 || e.keyCode == 13) {
            this.add();
          }
        },
        add: function () {
          parseSource(this.sourceValue, function (source, warning) {
            if (source) {
              source.col = colors[this.sources.length % colors.length];
              this.sources.push(source);
              this.sourceValue = null;
            } else {
              if (warning) {
                this.warning = warning;
                this.$.warning.show();
              }
            }
            this.showHideShares();
          }.bind(this));
        },
        shareSourcesKey: function (e) {
          if (e.which == 13 || e.keyCode == 13) {
            this.shareSources();
          }
        },
        shareSources: function (eventObj) {
          var i, new_state = {}, state, id, count;
          if (!global.gapi || !global.gapi.hangout) { return; }
          count = 0;
          state = global.gapi.hangout.data.getState();
          for (i = 0; i < this.sources.length; i++) {
            id = this.sources[i].type + '/' +
                 encodeURIComponent(this.sources[i].user || '') + '/' +
                 encodeURIComponent(this.sources[i].id || '');
            if (!state[id]) {
              new_state[id] = '1';
              count++;
            }
          }
          global.gapi.hangout.data.submitDelta(new_state, []);
          if (count > 0) {
            this.warning = count + ' new ' + (count === 1 ? ' source has' : ' sources have') + ' been added.';
            this.$.warning.show();
          } else {
            this.warning = 'No new sources available.';
            this.$.warning.show();
          }
        },
        showHideShares: function () {
          var i, j, added;
          for (i = 0; i < this.shares.length; i++) {
            added = false;
            for (j = 0; j < this.sources.length; j++) {
              if (this.shares[i].type == this.sources[j].type) {
                if (this.shares[i].user == this.sources[j].user && this.shares[i].id == this.sources[j].id) {
                  added = true;
                  break;
                }
                if (this.shares[i].activityId == this.sources[j].activityId) {
                  added = true;
                  break;
                }
              }
            }
            this.shares[i].added = added;
          }
        },
        updateShared: function (eventObj) {
          var item, state, share;
          if (!global.gapi || !global.gapi.hangout) { return; }
          if (eventObj && eventObj.state) {
            state = eventObj.state;
          } else {
            state = global.gapi.hangout.data.getState();
          }
          for (item in state) {
            if (state.hasOwnProperty(item)) {
              if (state[item] === '1') {
                share = item.split('/');
                if (share.length === 3) {
                  share[1] = decodeURIComponent(share[1]) || null;
                  share[2] = decodeURIComponent(share[2]) || null;
                  this.addSource(null, {
                    type: share[0],
                    user: share[1],
                    id: share[2],
                    shared: true
                  });
                }
              }
            }
          }
          this.showHideShares();
        },
        newestFirstChanged: function () {
          this.refresh();
        },
        refresh: function (e, details) {
          var i, j, entry, found;
          if (details && details.entries && details.entries.length > 0) {
            for (i = 0; i < details.entries.length; i++) {
              entry = details.entries[i];
              found = false;
              for (j = 0; j < this.entries.length; j++) {
                if (entry.id == this.entries[j].id && entry.type == this.entries[j].type) {
                  found = true;
                  if (entry.updated != this.entries[j].updated) {
                    entry.data.update = true;
                    this.entries[j].data = entry.data;
                  }
                  break;
                }
              }
              if (!found) {
                this.entries.push(entry);
              }
            }
          }
          if (this.newestFirst) {
            this.entries.sort(function (a, b) {
              if (a.pinned != b.pinned) {
                if (a.pinned) return -1;
                return 1;
              }
              return (b.sort - a.sort);
            });
          } else {
            this.entries.sort(function (a, b) {
              if (a.pinned != b.pinned) {
                if (a.pinned) return -1;
                return 1;
              }
              return (a.sort - b.sort);
            });
          }
        },
        domReady: function () {
          thisHandler = this;
          this.hangout = (global.gapi && global.gapi.hangout);
          if (global.location.search) {
            this.sourceValue = 'http://www.allmyplus.com/comment-tracker/app.html' + global.location.search;
            this.add();
            this.sourceValue = '';
          }
          if (global.gapi && global.gapi.hangout) {
            global.gapi.hangout.data.onStateChanged.add(this.updateShared.bind(this));
            this.updateShared();
          }
        }
      });
    }(this));
  </script>
</polymer-element>
